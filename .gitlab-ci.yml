variables:
  # https://gitlab.cern.ch/cms-cactus/ops/auto-devops/blob/master/tasks/variables/rpm-project.yml
  AUTO_DEVOPS_BUILD_IMAGE: ${CI_REGISTRY_IMAGE}/builder:${CI_COMMIT_REF_NAME}-cc7
  AUTO_DEVOPS_TEST_IMAGE: ${CI_REGISTRY_IMAGE}/builder:${CI_COMMIT_REF_NAME}-cc7
  AUTO_DEVOPS_DOCS_BUILD_TYPE: markdown
  AUTO_DEVOPS_RPM_PUBLISH_BRANCH_REGEX: /master/
  AUTO_DEVOPS_RPM_CERNBOX_FOLDER: /eos/user/a/avwebd2/ratemon_builds/$CI_COMMIT_REF_NAME/centos7_x86_64/base/RPMS/
  AUTO_DEVOPS_DOCKER_DISABLED: "true"
  GIT_SUBMODULE_STRATEGY: normal

# from https://gitlab.cern.ch/cms-cactus/ops/auto-devops/blob/master/project-types/rpm-project.yml
stages:
- base images 1
- base images 2
- build        # build and keep binaries
- test         # run tests
- build RPMs   # build and keep RPMs
- publish      # publish RPMs and docker images
- review       # deploy to review cluster
- deploy       # deploy to P5 (manually)
- cleanup      # un-deploy review (manually or when branch deleted)

include:
  - project: cms-cactus/ops/auto-devops
    ref: 0.0.2
    file: project-types/rpm-project.yml

builder image:
  extends: .auto_devops_docker_image_tagged_template
  stage: base images 1
  variables:
    BASE_OS: cc7
    BASE_TAG: 20200504-1.x86_64
    NAME: builder
    DOCKERFILE: builder.Dockerfile

OMS base image:
  extends: .auto_devops_docker_image_tagged_template
  stage: base images 1
  variables:
    BASE_OS: cc7
    BASE_TAG: 20200504-1.x86_64
    NAME: oms-base
    DOCKERFILE: oms-base.Dockerfile
    CONTEXT_FOLDER: oms
  
OMS Aggregator:
  extends: .auto_devops_make_build_template
  image: ${CI_REGISTRY_IMAGE}/oms-base:${CI_COMMIT_REF_NAME}-cc7
  script:
  - make -C oms
  artifacts:
    paths:
    - ./oms/aggregationapi/target/aggregation*.jar

ðŸš€ OMS Aggregator:
  extends: review app
  rules:
  variables:
    AUTO_DEVOPS_REVIEW_MANIFEST: oms/deploy.yml
  environment:
    name: oms/$CI_COMMIT_REF_NAME
    url: http://${CI_PROJECT_NAME}-${CI_COMMIT_REF_SLUG}.$KUBE_INGRESS_BASE_DOMAIN
    on_stop: ðŸ’£ OMS Aggregator

ðŸ’£ OMS Aggregator:
  extends: ðŸ’£ review app
  rules:
  variables:
    AUTO_DEVOPS_REVIEW_MANIFEST: oms/deploy.yml
  environment:
    name: oms/$CI_COMMIT_REF_NAME
    action: stop
