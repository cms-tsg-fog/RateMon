# include all templates in https://gitlab.cern.ch/cms-cactus/ops/auto-devops/-/tree/0.0.3
include:
  - project: cms-cactus/ops/auto-devops
    # ref can be a branch or tag name
    ref: 007ace82 # = 0.0.3 + auto_devops_docker_builder_autotag_onchange
    file: templates/all.yml

# Only run when a branch or git tag is defined
# this avoids accidents like
# - detached pipelines causing undefined behavior
# - triggering for merge requests, where the CI pretends your code is already on the master branch, 
#   and thus you unintentionally push your RPMs to your production yum repo prematurely
workflow:
  rules:
  - if: $CI_COMMIT_TAG     
  - if: $CI_COMMIT_BRANCH

stages:
- ğŸ› ï¸ setup
- ğŸ—ï¸ build
- ğŸ test
- ğŸ“¦ publish
- ğŸš€ deploy
- ğŸ’£ cleanup

builder image:
  extends: .auto_devops_docker_builder_autotag_onchange
  stage: ğŸ› ï¸ setup
  variables:
    DOCKERFILE: builder.Dockerfile
    CONTEXT_FOLDER: .gitlab/ci
    NAME: builder

make:
  image: $CI_REGISTRY_IMAGE/builder:$CI_COMMIT_REF_NAME-latest
  stage: ğŸ—ï¸ build
  script:
  - make
  artifacts:
    paths:
    - "/rpms"

docker:
  extends: .auto_devops_docker_builder_autotag
  stage: ğŸ“¦ publish
  variables:
    BUILD_ARG_CI_COMMIT_REF_NAME: $CI_COMMIT_REF_NAME

test:ratemon:
  stage: ğŸš€ deploy
  extends: .auto_devops_k8s_basic_deployment
  image: gitlab-registry.cern.ch/cms-cactus/ops/auto-devops/kubectl:gldirkx-multiline-secrets-latest
  variables:
    HTTP_PORT: 8085
  environment:
    on_stop: ğŸ’£ test:ratemon

ğŸ’£ test:ratemon:
  stage: ğŸ’£ cleanup
  extends: .auto_devops_k8s_basic_deployment_stop
  dependencies: ["test:ratemon"]
