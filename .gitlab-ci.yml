# include all templates in https://gitlab.cern.ch/cms-cactus/ops/auto-devops/-/tree/0.0.3
include:
  - project: cms-cactus/ops/auto-devops
    ref: 0.0.7
    file: templates/all.yml

# Only run when a branch or git tag is defined
# this avoids accidents like
# - detached pipelines causing undefined behavior
# - triggering for merge requests, where the CI pretends your code is already on the master branch, 
#   and thus you unintentionally push your RPMs to your production yum repo prematurely
workflow:
  rules:
  - if: $CI_COMMIT_TAG     
  - if: $CI_COMMIT_BRANCH

stages:
- 🛠️ setup
- 🏗️ build
- 🐞 test
- 📦 publish
- 🚀 deploy
- 💣 cleanup

builder image:
  extends: .auto_devops_docker_builder_autotag_onchange
  stage: 🛠️ setup
  variables:
    DOCKERFILE: builder.Dockerfile
    CONTEXT_FOLDER: .gitlab/ci
    NAME: builder

build:RPMs:
  image: $CI_REGISTRY_IMAGE/builder:$CI_COMMIT_REF_NAME-latest
  stage: 🏗️ build
  script:
  - make
  artifacts:
    paths:
    - rpms

publish:docker:
  extends: .auto_devops_docker_builder_autotag
  stage: 📦 publish
  variables:
    BUILD_ARG_CI_COMMIT_REF_NAME: $CI_COMMIT_REF_NAME

publish:docker:P5:
  extends: .auto_devops_docker_builder_autotag
  stage: 📦 publish
  variables:
    DOCKERFILE: P5.Dockerfile
    NAME: p5


publish:RPMs:
  stage: 📦 publish
  extends: .auto_devops_upload_yum_repo_eos_template
  variables:
    LOCAL_FOLDER: rpms/python36
    CERNBOX_FOLDER: /eos/user/c/cactus/www/cactus/release/cms-tsg-fog/ratemon/$CI_COMMIT_REF_SLUG/python36/$CI_COMMIT_SHA/centos7_gcc8_x86_64/

publish:RPMs:P5:
  stage: 📦 publish
  extends: .auto_devops_upload_yum_repo_eos_template
  variables:
    LOCAL_FOLDER: rpms/python34
    CERNBOX_FOLDER: /eos/user/c/cactus/www/cactus/release/cms-tsg-fog/ratemon/$CI_COMMIT_REF_SLUG/python34/$CI_COMMIT_SHA/centos7_gcc8_x86_64/


deploy:test:
  stage: 🚀 deploy
  extends: .auto_devops_k8s_basic_deployment
  variables:
    HTTP_PORT: 8085
  environment:
    on_stop: cleanup:test

cleanup:test:
  stage: 💣 cleanup
  extends: .auto_devops_k8s_basic_deployment_stop
  dependencies: ["deploy:test"]

# trigger this job by manually creating a pipeline with your P5 credentials
deploy:P5:
  stage: 🚀 deploy
  extends: .auto_devops_p5_dropbox_push
  rules:
    # omit if user did not supply P5 credentials
  - if: $P5_USER == null || $P5_PASS == null
    when: never
    # only when tagged
  - if: $PACKAGE_VER_PATCH || $CI_COMMIT_TAG
    when: manual
    allow_failure: false
  - when: never
  variables:
    LOCAL_FOLDER: rpms/python34
    DROPBOX_OS: cc7
    DROPBOX_ZONE: cms
    DROPBOX_NAME: ratemon
    SSH_USERNAME: $P5_USER
    SSH_PASS: $P5_PASS